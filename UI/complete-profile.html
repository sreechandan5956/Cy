<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Complete Your Profile | CyTutor</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="styles/cyber-noir.css">
<style>
    body {
        background: #000000;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .cyber-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.4;
    }

    .form-container {
        background: rgba(10, 10, 10, 0.95);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: 16px;
        padding: 3rem;
        max-width: 600px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(34, 197, 94, 0.2);
    }

    .form-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .form-title {
        font-size: 2rem;
        font-weight: 700;
        color: #22c55e;
        margin-bottom: 0.5rem;
    }

    .form-subtitle {
        color: #aaa;
        font-size: 0.95rem;
    }

    .progress-bar {
        height: 4px;
        background: rgba(34, 197, 94, 0.2);
        border-radius: 2px;
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #22c55e, #10b981);
        width: 0%;
        transition: width 0.3s ease;
    }

    .form-step {
        display: none;
    }

    .form-step.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        color: #e5e5e5;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .form-label .required {
        color: #ef4444;
    }

    .form-input {
        width: 100%;
        padding: 0.875rem 1rem;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid rgba(34, 197, 94, 0.2);
        border-radius: 8px;
        color: #e5e5e5;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    .form-input::placeholder {
        color: #666;
    }

    .form-select {
        width: 100%;
        padding: 0.875rem 1rem;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid rgba(34, 197, 94, 0.2);
        border-radius: 8px;
        color: #e5e5e5;
        font-size: 1rem;
        cursor: pointer;
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .btn-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn {
        flex: 1;
        padding: 0.875rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #000;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
    }

    .btn-secondary {
        background: transparent;
        border: 2px solid #22c55e;
        color: #22c55e;
    }

    .btn-secondary:hover {
        background: rgba(34, 197, 94, 0.1);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        display: none;
    }

    .error-message.show {
        display: block;
    }

    .success-message {
        text-align: center;
        padding: 2rem;
    }

    .success-icon {
        font-size: 4rem;
        color: #22c55e;
        margin-bottom: 1rem;
    }

    @media (max-width: 640px) {
        .form-container {
            padding: 2rem 1.5rem;
        }

        .btn-group {
            flex-direction: column;
        }
    }
</style>
</head>

<body>
<canvas id="particles-bg" class="cyber-bg"></canvas>

<div class="form-container">
    <div class="form-header">
        <h1 class="form-title">Complete Your Profile</h1>
        <p class="form-subtitle">Let's set up your account to get started</p>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
    </div>

    <form id="profileForm">
        <!-- Step 1: Basic Info & Avatar -->
        <div class="form-step active" data-step="1">
            <div class="form-group" style="text-align: center; margin-bottom: 2rem;">
                <div style="position: relative; display: inline-block;">
                    <div id="avatarPreview" style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #22c55e, #16a34a); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #000; border: 4px solid rgba(34, 197, 94, 0.3); overflow: hidden; margin: 0 auto;">
                        <span id="avatarInitials">?</span>
                        <img id="avatarImage" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>
                    <label for="avatarUpload" style="position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; background: #22c55e; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid #000;">
                        <i class="fas fa-camera" style="color: #000;"></i>
                    </label>
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                </div>
                <p style="color: #aaa; font-size: 0.875rem; margin-top: 0.5rem;">Upload profile picture (optional)</p>
            </div>

            <div class="form-group">
                <label class="form-label">Full Name <span class="required">*</span></label>
                <input type="text" class="form-input" id="fullName" placeholder="Enter your full name" required onkeyup="updateAvatarInitials()">
                <div class="error-message" id="nameError">Please enter your full name</div>
            </div>

            <div class="form-group">
                <label class="form-label">Username <span class="required">*</span></label>
                <input type="text" class="form-input" id="username" placeholder="Choose a unique username" required>
                <div class="error-message" id="usernameError">Username must be 3-20 characters</div>
            </div>

            <div class="form-group">
                <label class="form-label">Email <span class="required">*</span></label>
                <input type="email" class="form-input" id="email" placeholder="your.email@example.com" required readonly>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer; color: #e5e5e5;">
                    <input type="checkbox" id="termsAccept" required style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 0.9rem;">I agree to the <a href="#" style="color: #22c55e; text-decoration: none;">Terms of Service</a> and <a href="#" style="color: #22c55e; text-decoration: none;">Privacy Policy</a> <span class="required">*</span></span>
                </label>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="nextStep()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Additional Info -->
        <div class="form-step" data-step="2">
            <div class="form-group">
                <label class="form-label">Location</label>
                <input type="text" class="form-input" id="location" placeholder="City, Country">
            </div>

            <div class="form-group">
                <label class="form-label">Experience Level <span class="required">*</span></label>
                <select class="form-select" id="experienceLevel" required>
                    <option value="">Select your level</option>
                    <option value="beginner">Beginner - Just starting out</option>
                    <option value="intermediate">Intermediate - Some experience</option>
                    <option value="advanced">Advanced - Experienced professional</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Areas of Interest</label>
                <select class="form-select" id="interests" multiple size="4">
                    <option value="web">Web Security</option>
                    <option value="crypto">Cryptography</option>
                    <option value="forensics">Digital Forensics</option>
                    <option value="malware">Malware Analysis</option>
                    <option value="network">Network Security</option>
                    <option value="reverse">Reverse Engineering</option>
                </select>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button type="button" class="btn btn-primary" onclick="nextStep()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 3: Bio & Goals -->
        <div class="form-step" data-step="3">
            <div class="form-group">
                <label class="form-label">Bio</label>
                <textarea class="form-input form-textarea" id="bio" placeholder="Tell us about yourself..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Learning Goals</label>
                <textarea class="form-input form-textarea" id="goals" placeholder="What do you want to achieve?"></textarea>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-check"></i> Complete Setup
                </button>
            </div>
        </div>

        <!-- Success Message with Checklist -->
        <div class="form-step" data-step="4">
            <div class="success-message">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 style="color: #22c55e; margin-bottom: 1rem;">Welcome to CyTutor! ðŸŽ‰</h2>
                <p style="color: #aaa; margin-bottom: 2rem;">Your account has been set up successfully. Check your email for a welcome message!</p>
                
                <div style="background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; text-align: left;">
                    <h3 style="color: #22c55e; margin-bottom: 1rem; font-size: 1.125rem;">
                        <i class="fas fa-list-check"></i> Getting Started Checklist
                    </h3>
                    <div style="display: grid; gap: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-check-circle" style="color: #22c55e;"></i>
                            <span style="color: #e5e5e5;">Complete your profile</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="far fa-circle" style="color: #666;"></i>
                            <span style="color: #aaa;">Solve your first challenge</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="far fa-circle" style="color: #666;"></i>
                            <span style="color: #aaa;">Explore learning domains</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="far fa-circle" style="color: #666;"></i>
                            <span style="color: #aaa;">Earn your first badge</span>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="goToDashboard()">
                    Go to Dashboard <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
let currentStep = 1;
const totalSteps = 3;

// Get email from URL params or localStorage
const urlParams = new URLSearchParams(window.location.search);
const userEmail = urlParams.get('email') || localStorage.getItem('pendingEmail') || '';
document.getElementById('email').value = userEmail;

// Update progress bar
function updateProgress() {
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

// Show specific step
function showStep(step) {
    document.querySelectorAll('.form-step').forEach(el => {
        el.classList.remove('active');
    });
    document.querySelector(`[data-step="${step}"]`).classList.add('active');
    currentStep = step;
    updateProgress();
}

// Next step
function nextStep() {
    if (validateStep(currentStep)) {
        if (currentStep < totalSteps) {
            showStep(currentStep + 1);
        }
    }
}

// Previous step
function prevStep() {
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

// Handle avatar upload
let avatarFile = null;

function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (file) {
        avatarFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('avatarImage').src = e.target.result;
            document.getElementById('avatarImage').style.display = 'block';
            document.getElementById('avatarInitials').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
}

// Update avatar initials
function updateAvatarInitials() {
    const name = document.getElementById('fullName').value.trim();
    if (name && !avatarFile) {
        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        document.getElementById('avatarInitials').textContent = initials || '?';
    }
}

// Validate current step
function validateStep(step) {
    if (step === 1) {
        const fullName = document.getElementById('fullName').value.trim();
        const username = document.getElementById('username').value.trim();
        const termsAccept = document.getElementById('termsAccept').checked;
        
        if (fullName.length < 2) {
            showError('nameError');
            return false;
        }
        
        if (username.length < 3 || username.length > 20) {
            showError('usernameError');
            return false;
        }
        
        if (!termsAccept) {
            alert('Please accept the Terms of Service and Privacy Policy');
            return false;
        }
        
        return true;
    }
    
    if (step === 2) {
        const experienceLevel = document.getElementById('experienceLevel').value;
        if (!experienceLevel) {
            alert('Please select your experience level');
            return false;
        }
        return true;
    }
    
    return true;
}

// Show error message
function showError(errorId) {
    const errorEl = document.getElementById(errorId);
    errorEl.classList.add('show');
    setTimeout(() => {
        errorEl.classList.remove('show');
    }, 3000);
}

// Handle form submission
document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!validateStep(currentStep)) return;
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    // Collect form data
    const formData = new FormData();
    formData.append('fullName', document.getElementById('fullName').value.trim());
    formData.append('username', document.getElementById('username').value.trim());
    formData.append('email', document.getElementById('email').value.trim());
    formData.append('location', document.getElementById('location').value.trim());
    formData.append('experienceLevel', document.getElementById('experienceLevel').value);
    formData.append('interests', JSON.stringify(Array.from(document.getElementById('interests').selectedOptions).map(opt => opt.value)));
    formData.append('bio', document.getElementById('bio').value.trim());
    formData.append('goals', document.getElementById('goals').value.trim());
    formData.append('termsAccepted', true);
    
    if (avatarFile) {
        formData.append('avatar', avatarFile);
    }
    
    try {
        // Send to backend
        const response = await fetch('http://localhost:5000/api/user/complete-profile', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Save user data
            localStorage.setItem('user', JSON.stringify(data.user));
            localStorage.removeItem('pendingEmail');
            
            // Send welcome email
            await sendWelcomeEmail(data.user);
            
            // Show success
            showStep(4);
        } else {
            throw new Error('Failed to save profile');
        }
    } catch (error) {
        console.error('Error:', error);
        
        // Fallback: Save to localStorage
        const userData = {
            name: formData.get('fullName'),
            username: formData.get('username'),
            email: formData.get('email'),
            location: formData.get('location'),
            experienceLevel: formData.get('experienceLevel'),
            interests: JSON.parse(formData.get('interests')),
            bio: formData.get('bio'),
            goals: formData.get('goals'),
            createdAt: new Date().toISOString()
        };
        
        localStorage.setItem('user', JSON.stringify(userData));
        
        // Send welcome email
        await sendWelcomeEmail(userData);
        
        // Show success
        showStep(4);
    }
});

// Send welcome email
async function sendWelcomeEmail(user) {
    try {
        await fetch('http://localhost:5000/api/email/welcome', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: user.email,
                name: user.name,
                username: user.username
            })
        });
    } catch (error) {
        console.log('Welcome email will be sent by backend');
    }
}

// Go to dashboard
function goToDashboard() {
    window.location.href = 'dashboard.html';
}

// Particle animation
const canvas = document.getElementById('particles-bg');
const ctx = canvas.getContext('2d');
const particles = [];
const particleCount = 80;

function setCanvasSize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
setCanvasSize();
window.addEventListener('resize', setCanvasSize);

class Particle {
    constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = Math.random() * 0.5 - 0.25;
        this.vy = Math.random() * 0.5 - 0.25;
        this.size = Math.random() * 2;
        this.color = Math.random() < 0.5 ? '#22c55e' : '#10b981';
    }

    update() {
        this.x += this.vx;
        this.y += this.vy;
        if (this.x < 0) this.x = canvas.width;
        if (this.x > canvas.width) this.x = 0;
        if (this.y < 0) this.y = canvas.height;
        if (this.y > canvas.height) this.y = 0;
    }

    draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
    }
}

for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
}

function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(particle => {
        particle.update();
        particle.draw();
    });
    particles.forEach((p1, i) => {
        particles.slice(i + 1).forEach(p2 => {
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < 150) {
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.strokeStyle = `rgba(34, 197, 94, ${0.1 * (1 - distance/150)})`;
                ctx.stroke();
            }
        });
    });
    requestAnimationFrame(animate);
}

animate();

// Initialize
updateProgress();
</script>

</body>
</html>
